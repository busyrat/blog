(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{544:function(t,s,a){"use strict";a.r(s);var n=a(18),e=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab-ci"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci","aria-hidden":"true"}},[t._v("#")]),t._v(" GitLab CI")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.gitlab.com/runner/install/",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitLab Runner"),a("OutboundLink")],1)]),t._v(" "),a("p",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/README.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitLab CI"),a("OutboundLink")],1)]),t._v(" "),a("h2",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# 下载镜像\nsudo docker pull gitlab/gitlab-runner:latest\n\n# 启动\nsudo docker run -d --name gitlab-runner --restart always \\\n>   -v /srv/gitlab-runner/config:/etc/gitlab-runner \\\n>   -v /var/run/docker.sock:/var/run/docker.sock \\\n>   gitlab/gitlab-runner:latest\n\n# 注册\nsudo docker exec -it gitlab-runner gitlab-ci-multi-runner register\n")])])]),a("p",[t._v("生成的 "),a("code",[t._v("/srv/gitlab-runner/config/config.toml")]),t._v(" 文件")]),t._v(" "),a("div",{staticClass:"language-toml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("concurrent")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 同时1个runner运行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("check_interval")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("session_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("session_timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1800")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 多个runner类似的结构")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("name")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wh-fe-62-101"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("url")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://git.wh.com/"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("token")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"d66c0d2167e5c450e0e6d3e3009ed7"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("executor")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.custom_build_dir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.docker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("tls_verify")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("image")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"alpine:latest"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("privileged")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("disable_entrypoint_overwrite")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("oom_kill_disable")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("disable_cache")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("volumes")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v('"/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("shm_size")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache.s3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.cache.gcs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("h2",{attrs:{id:"补充"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#补充","aria-hidden":"true"}},[t._v("#")]),t._v(" 补充")]),t._v(" "),a("h3",{attrs:{id:"ssh-常用操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssh-常用操作","aria-hidden":"true"}},[t._v("#")]),t._v(" SSH 常用操作")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("生成 ssh-key： "),a("code",[t._v("ssh-keygen")]),t._v(" ，默认情况下会在 "),a("code",[t._v("~/.ssh/")]),t._v("目录下生成两个文件："),a("code",[t._v("id_rsa")]),t._v("、"),a("code",[t._v("id_rsa.pub")]),t._v("，分别存放私钥和公钥")])]),t._v(" "),a("li",[a("p",[t._v("gitlab / github 仓库免密 "),a("code",[t._v("clone")]),t._v(" 代码，需要将 ssh 的公钥添加到目标平台的 SSH Keys 中")])]),t._v(" "),a("li",[a("p",[t._v("免密登录服务器：将客户端的公钥复制到服务器的 "),a("code",[t._v("~/.ssh/authorized_keys")]),t._v(" 里面")])]),t._v(" "),a("li",[a("p",[t._v("第一次连接 ssh 出现一个询问：")]),t._v(" "),a("div",{staticClass:"language-cmd extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("$ ssh xx.xx.xx.xx\nThe authenticity of host 'xx.xx.xx.xx (xx.xx.xx.xx)' can't be established. \n")])])]),a("p",[t._v("关闭这个地提示可以加上 "),a("code",[t._v("ssh -o StrictHostKeyChecking=no xx.xx.xx.xx")])])]),t._v(" "),a("li",[a("p",[t._v("有个很好用的工具 "),a("code",[t._v("sshpass")]),t._v(" ，免 "),a("code",[t._v("ssh")]),t._v(" 登录交互，使用 "),a("code",[t._v("sshpass -p [password] ssh ...")])])])]),t._v(" "),a("p",[t._v("###Docker 常用操作")]),t._v(" "),a("ul",[a("li",[t._v("docker images 查看本地的镜像")]),t._v(" "),a("li",[t._v("docker run -it [image-name] /bin/bash 运行镜像并进入")]),t._v(" "),a("li",[t._v("docker ps 查看进程，"),a("code",[t._v("docker ps -as")]),t._v(" 查看所有进程")]),t._v(" "),a("li",[t._v("docker rm [contrainer-name] 删除容器")]),t._v(" "),a("li",[t._v("docker image rm [image-name] 删除镜像")])]),t._v(" "),a("h3",{attrs:{id:"ci-脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ci-脚本","aria-hidden":"true"}},[t._v("#")]),t._v(" CI 脚本")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" eval $(ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("s)\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('add <(echo "$SSH_PRIVATE_KEY")\n  '),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 创建 .ssh 目录，-p --parents 可以创建一个路径的名称，不存在就自动创建")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mkdir "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p ~/.ssh\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'[[ -f /.dockerenv ]] && echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config'")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"runner使用本地image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runner使用本地image","aria-hidden":"true"}},[t._v("#")]),t._v(" runner使用本地image")]),t._v(" "),a("div",{staticClass:"language-toml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("runners.docker")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("volumes")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v('"/cache"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("pull_policy")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"if-not-present"')]),t._v("\t// 添加这一行配置，重启runner\n")])])]),a("p",[a("a",{attrs:{href:"https://www.jianshu.com/p/2b7e73b0a096",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考"),a("OutboundLink")],1)])])},[],!1,null,null,null);s.default=e.exports}}]);