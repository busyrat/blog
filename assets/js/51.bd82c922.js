(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{569:function(e,o,t){"use strict";t.r(o);var _=t(18),v=Object(_.a)({},function(){var e=this,o=e.$createElement,t=e._self._c||o;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"zentao"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#zentao","aria-hidden":"true"}},[e._v("#")]),e._v(" zentao")]),e._v(" "),t("h2",{attrs:{id:"利用docker搭建禅道服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#利用docker搭建禅道服务器","aria-hidden":"true"}},[e._v("#")]),e._v(" 利用docker搭建禅道服务器")]),e._v(" "),t("h3",{attrs:{id:"要求："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#要求：","aria-hidden":"true"}},[e._v("#")]),e._v(" 要求：")]),e._v(" "),t("ul",[t("li",[e._v("使用ubuntu镜像")]),e._v(" "),t("li",[e._v("使用Dockfile创建镜像")]),e._v(" "),t("li",[e._v("数据持久化")])]),e._v(" "),t("h3",{attrs:{id:"安装计划"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装计划","aria-hidden":"true"}},[e._v("#")]),e._v(" 安装计划")]),e._v(" "),t("ul",[t("li",[e._v("禅道数据持久化：将宿主机的"),t("code",[e._v("/home/docker/zentao/data")]),e._v("目录挂载到禅道容器内的"),t("code",[e._v("/opt/zbox/data")]),e._v("目录")]),e._v(" "),t("li",[e._v("禅道"),t("code",[e._v("mysql")]),e._v("数据库端口："),t("code",[e._v("3306")])]),e._v(" "),t("li",[e._v("禅道"),t("code",[e._v("apache")]),e._v("端口："),t("code",[e._v("8091")])]),e._v(" "),t("li",[e._v("一些脚本路径："),t("code",[e._v("/home/docker/zentao")])]),e._v(" "),t("li",[e._v("使用"),t("code",[e._v("entrypoint.sh")]),e._v("作为容器启动时首先运行的脚本")])]),e._v(" "),t("h3",{attrs:{id:"下载禅道一键安装包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#下载禅道一键安装包","aria-hidden":"true"}},[e._v("#")]),e._v(" 下载禅道一键安装包")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("下载"),t("code",[e._v("ubuntu")]),e._v("镜像，这里使用16.04版本")]),e._v(" "),t("pre",[t("code",[e._v("  docker pull ubuntu:16.04\n")])])]),e._v(" "),t("li",[t("p",[e._v("从"),t("a",{attrs:{href:"http://www.zentao.net/download/80046.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("禅道官网"),t("OutboundLink")],1),e._v("下载 "),t("code",[e._v("Linux 64位一键安装包（适用于Linux 64位）")]),e._v("，这里下载9.5稳定版，放到"),t("code",[e._v("/home/docker/zentao/build/files")]),e._v("目录下")])])]),e._v(" "),t("h3",{attrs:{id:"持久化数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#持久化数据","aria-hidden":"true"}},[e._v("#")]),e._v(" 持久化数据")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("解压禅道一键安装包")]),e._v(" "),t("pre",[t("code",[e._v("  tar xvzf /home/docker/zentao/build/files/ZenTaoPMS.9.5.stable.zbox_64.tar.gz \n")])])]),e._v(" "),t("li",[t("p",[e._v("将解压后的目录 "),t("code",[e._v("/home/docker/zentao/build/files/zbox/data")]),e._v(" 拷贝到 "),t("code",[e._v("/home/docker/zentao")]),e._v(" 下，目录权限暂时不用修改，禅道初始化的时候会自动修改")]),e._v(" "),t("pre",[t("code",[e._v("  cp -r /home/docker/zentao/build/files/zbox/data /home/docker/zentao\n")])])]),e._v(" "),t("li",[t("p",[e._v("解压后的目录不再需要，删除掉")]),e._v(" "),t("pre",[t("code",[e._v("  rm -rf /home/docker/zentao/build/files/zbox/\n")])])])]),e._v(" "),t("h2",{attrs:{id:"制作entrypoint脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#制作entrypoint脚本","aria-hidden":"true"}},[e._v("#")]),e._v(" 制作entrypoint脚本")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("在"),t("code",[e._v("/home/docker/zentao/build/files")]),e._v("目录下创建文件"),t("code",[e._v("entrypoint.sh")]),e._v("，添加以下内容：")]),e._v(" "),t("pre",[t("code",[e._v("  #!/bin/sh\n  /opt/zbox/zbox start\n  \n  #keep docker running\n  while true\n  do\n    sleep 10\n  done\n")])])]),e._v(" "),t("li",[t("p",[e._v("脚本中"),t("code",[e._v("/opt/zbox/zbox start")]),e._v("命令是启动禅道服务器，由于禅道服务器是在后台运行的，因此需要添加下面的一个无限循环使脚本一直运作，否则docker会自动停止容器")])])]),e._v(" "),t("h3",{attrs:{id:"制作dockfile文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#制作dockfile文件","aria-hidden":"true"}},[e._v("#")]),e._v(" 制作Dockfile文件")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("在"),t("code",[e._v("/home/docker/zentao/build")]),e._v("目录下创建文件"),t("code",[e._v("Dockfile")]),e._v("，添加以下内容：")]),e._v(" "),t("pre",[t("code",[e._v('  FROM ubuntu:16.04\n  MAINTAINER zhouchunsong\n  \n  #Deploye ZenTao\n  COPY files /root\n  \n  USER root \n  \n  RUN tar -xzf /root/ZenTaoPMS.9.5.stable.zbox_64.tar.gz -C /opt \\\n      && rm -rf /opt/zbox/data \\\n      && rm -f /root/ZenTaoPMS.9.5.stable.zbox_64.tar.gz \\\n      &&/opt/zbox/zbox -ap 8091 \\\n      &&/opt/zbox/zbox -mp 3306  \n  \n  #start zentao\n  ENTRYPOINT ["/root/entrypoint.sh"]\n')])]),e._v(" "),t("ul",[t("li",[t("code",[e._v("FROM")]),e._v(" ： 指明继承自哪个镜像")]),e._v(" "),t("li",[t("code",[e._v("MAINTAINER")]),e._v(" ： 作者信息")]),e._v(" "),t("li",[t("code",[e._v("COPY files /root")]),e._v(" ： 将"),t("code",[e._v("files")]),e._v("目录中的文件添加到容器的"),t("code",[e._v("/root")]),e._v("目录中，前面的步骤中我们添加了"),t("code",[e._v("禅道一键安装包")]),e._v("和"),t("code",[e._v("entrypoint.sh")]),e._v("文件到"),t("code",[e._v("files")]),e._v("目录中")]),e._v(" "),t("li",[t("code",[e._v("USER root")]),e._v(" ： 使用"),t("code",[e._v("root")]),e._v("用户执行下面的命令（"),t("code",[e._v("RUN、CMD、ENTRYPOINT")]),e._v("）")]),e._v(" "),t("li",[t("code",[e._v("RUN")]),e._v(" ： 第一行 将"),t("code",[e._v("禅道一键安装包")]),e._v("解压到"),t("code",[e._v("/opt")]),e._v("目录下")]),e._v(" "),t("li",[t("code",[e._v("RUN")]),e._v(" ： 第二行 删除data目录（因为我们要用宿主机的data目录挂载到该位置，所以容器内的目录不需要了）")]),e._v(" "),t("li",[t("code",[e._v("RUN")]),e._v(" ： 第三行 删除"),t("code",[e._v("禅道一键安装包")])]),e._v(" "),t("li",[t("code",[e._v("RUN")]),e._v(" ： 第四行 指定禅道"),t("code",[e._v("apache")]),e._v("服务端口为"),t("code",[e._v("8091")])]),e._v(" "),t("li",[t("code",[e._v("RUN")]),e._v(" ： 第五行 指定禅道"),t("code",[e._v("mysql")]),e._v("服务端口为"),t("code",[e._v("3306")])]),e._v(" "),t("li",[t("code",[e._v("ENTRYPOINT")]),e._v(" : 指定容器启动时第一个运行的脚本为："),t("code",[e._v("/root/entrypoint.sh")])])])])]),e._v(" "),t("h3",{attrs:{id:"构建镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#构建镜像","aria-hidden":"true"}},[e._v("#")]),e._v(" 构建镜像")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("在"),t("code",[e._v("/home/docker/zentao/build")]),e._v("目录下执行命令")]),e._v(" "),t("pre",[t("code",[e._v("  docker build -t zcs/zentao:9.5 .\n")])]),e._v(" "),t("ul",[t("li",[t("p",[t("code",[e._v("docker build")]),e._v(" : 构建命令")])]),e._v(" "),t("li",[t("p",[t("code",[e._v("-t zcs/zentao:9.5")]),e._v(" ： 指定构建镜像的tag")])]),e._v(" "),t("li",[t("p",[t("code",[e._v(".")]),e._v(" ： 指定上下文目录，也就是files所在目录，需要注意"),t("code",[e._v("files")]),e._v("并不是指构建命令执行时所在的目录")]),e._v(" "),t("p",[t("strong",[e._v("注意：不要误以为 "),t("code",[e._v(".")]),e._v(" 是指定 "),t("code",[e._v("Dockerfile")]),e._v(" 所在目录，在默认情况下，如果不额外指定 Dockerfile的话，会将上下文目录下的名为 "),t("code",[e._v("Dockerfile")]),e._v(" 的文件作为 "),t("code",[e._v("Dockerfile")]),e._v("，也可以用\n"),t("code",[e._v("-f ../Dockerfile.php")]),e._v(" 参数指定某个文件作为 "),t("code",[e._v("Dockerfile")]),e._v("，如果在"),t("code",[e._v("/home/docker/zentao/")]),e._v("\n执行构建，则指令变为"),t("code",[e._v("docker build -t zcs/zentao:9.5 ./build/")])])])])])]),e._v(" "),t("li",[t("p",[e._v("构建成功后使用"),t("code",[e._v("docker images")]),e._v("命令可以查看到该镜像")]),e._v(" "),t("pre",[t("code",[e._v("  zhouchunsong@JuGuang:/home/docker/zentao$ docker images\n  REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE\n  zcs/zentao            9.5                 682bb7308c02        3 hours ago         724MB\n  sonatype/nexus3       latest              9ded7bd31da5        5 days ago          480MB\n  jenkins/jenkins       lts                 b36e8b881678        5 days ago          810MB\n  httpd                 latest              b669148bb5a5        9 days ago          177MB\n  stilliard/pure-ftpd   latest              193339b4053f        2 weeks ago         439MB\n  ubuntu                16.04               ccc7a11d65b1        5 weeks ago         120MB\n  hello-world           latest              1815c82652c0        3 months ago        1.84kB\n")])])])]),e._v(" "),t("h3",{attrs:{id:"首次运行容器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#首次运行容器","aria-hidden":"true"}},[e._v("#")]),e._v(" 首次运行容器")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("执行命令")]),e._v(" "),t("pre",[t("code",[e._v("  docker run -dit -p 8091:8091 -p 3306:3306 --name zantao -v /home/docker/zentao/data:/opt/zbox/data zcs/zentao:9.5\n")])]),e._v(" "),t("ul",[t("li",[e._v("这里参数不再解释，可以看前面几篇教程")])])])]),e._v(" "),t("h3",{attrs:{id:"检查安装是否成功"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#检查安装是否成功","aria-hidden":"true"}},[e._v("#")]),e._v(" 检查安装是否成功")]),e._v(" "),t("ul",[t("li",[e._v("可用性检查，访问 "),t("a",{attrs:{href:"http://192.168.1.56:8091",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://192.168.1.56:8091"),t("OutboundLink")],1),e._v("，可以正常打开禅道页面，默认帐号 "),t("code",[e._v("admin")]),e._v("，密码"),t("code",[e._v("123456")])]),e._v(" "),t("li",[e._v("数据持久化检查，在禅道中新建一个测试产品，删除当前容器，再重新启动一个容器，测试产品没有被删除")])]),e._v(" "),t("h3",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考","aria-hidden":"true"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://www.zentao.net/book/zentaopmshelp/90.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("禅道安装文档"),t("OutboundLink")],1)])])])},[],!1,null,null,null);o.default=v.exports}}]);